# SmartSit


SmartSit is a project to detect vehicles on highways using magnetic
sensors and WSN technology.

As of now, we use SmartMesh Wireless Hart from Linear Technology for the WSN part.
The project is built on an atmega328p and  a HMC-5883l as the magnetic sensor.
On the software side, the firmware is built using my port of FreeRTOS for the 
AVR, the BareBones WHT library for communicating with the SmartMesh mote and
some I2C drivers for interfacing with the magnetic sensor.

## Overview
The AVR will sample the magnetic sensor at the highest rate possible (160Hz) 
provided by an external interrupt from the HMC-58853L , then collect a defined
number of samples on a buffer and send it to the mote wich will then send it to the manager.
Everything is managed through tasks, queues and semaphores given by the FreeRTOS.
A PC connected to the manager and running the modified APIExplorer program will
receive and process the data sent by each mote.

## How to use
Visit the [BareBones WHT repository](https://github.com/Ripagood/BareBonesWHT) 
for an indepth description of how to connect the mote to the AVR and how to use 
the APIExplorer program to receive data.
Other important aspects are defined in the SmartSit.h file.

For a sample of the file generated by a single mote check [here](https://github.com/Ripagood/SmartSit/blob/master/log1Mote5.txt)


## Features

### Data Visualization

Run APIExplorer.py , filter the important data, convert it to Gauss and plot it in real time.
Going UNIX Style we will just pipe and glue together various programms. 
python APIExplorer.py | awk 'BEGIN {FS=","}{print $10; fflush()}' | ./plotting.py | ./driveGnuPlots.pl 3 500 500 500 "X" "Z" "Y"
For a sample, use the following command:
cat log1Mote5.txt | awk 'BEGIN {FS=","}{print $10; fflush()}' | ./plotting.py | ./driveGnuPlots.pl 3 500 500 500 "X" "Z" "Y"

Click [here](https://youtu.be/uINeaHeTg8o) to see the plot in realtime.

#### Visualization Modes

##### Single Node, 3 Windows for X,Y,Z
cat log1Mote5.txt | awk 'BEGIN {FS=","}{print $10; fflush()}' | ./plotting.py | ./driveGnuPlots.pl 3 500 500 500 "X" "Z" "Y"

##### Single Node, 1 Window for X,Y,Z
cat log1Mote5.txt | awk 'BEGIN {FS=","}{print $10; fflush()}' | ./plotting.py | ./driveGnuPlotStreams.pl 3 1 500 -100000 100000 500x300+0+0 'X' 'Y' 'Z' 0 0 0


### Easy Data Acquisition

Using the interrupt driven SPI library ,the analogue inputs of the AVR and the mesh network
formed with the LT technology, wireless data acquisition in real time is easy and reliable. The SmartSit
project can be used as start point for other wireless sensor network solutions.




## To Do

### Real data throughput rates
There are still some tests to do regarding the number of motes the WSN will manage
to serve at the given rate .Even so, the firmware is pretty much ready for a commercial or industrial
application. I strongly advise to use a much lower sample rate or to lower the amount
of data to be sent with each mote.

### Low Power Mode
In theory really simple, just add an IdleHook function to the RTOS which will then 
put the AVR on a deep sleep.

### Demo Video
Even though I already have some videos of the system, one with data visualization
would be much better.







